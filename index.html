<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>çµŒè²»ç™»éŒ²ï¼ˆ30ç§’ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0}
  .card{background:#fff;margin:12px;padding:16px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}
  h1{font-size:18px;margin:0 0 12px}
  label{font-weight:650;display:block;margin-top:12px}
  input,select,button,textarea{width:100%;padding:10px;margin-top:6px;font-size:14px;box-sizing:border-box}
  textarea{min-height:120px;resize:vertical}
  button{border:none;border-radius:10px}
  .primary{background:#2563eb;color:#fff;font-size:16px;margin-top:16px}
  .ghost{background:#e5e7eb}
  .badge{display:inline-block;padding:6px 10px;border-radius:8px;font-size:13px;margin-top:8px}
  .ok{background:#16a34a;color:#fff}
  .warn{background:#facc15}
  .danger{background:#dc2626;color:#fff}
  .hidden{display:none}
  .small{font-size:12px;color:#6b7280;margin-top:6px;line-height:1.45}
  .relax{margin-top:16px;padding:12px;border-radius:10px;background:#f0f9ff;font-size:14px}
  .topbar{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .topbar .title{font-weight:800}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1e40af;font-size:12px}
  dialog{width:min(760px,95vw);border:none;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .dlgHeader{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .dlgBody{padding:14px 16px}
  .dlgFooter{padding:14px 16px;border-top:1px solid #e5e7eb;display:flex;gap:10px;flex-wrap:wrap}
  .dangerText{color:#b91c1c;font-weight:800}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .kpi > div{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>
</head>
<body>

<div class="card">
  <div class="topbar">
    <div class="title">ğŸ“¸ çµŒè²»ç™»éŒ²ï¼ˆ30ç§’ï¼‰</div>
    <div class="row" style="flex:0 0 auto; gap:8px">
      <button id="openSettings" class="ghost" style="width:auto;padding:10px 12px">âš™ï¸ è¨­å®š</button>
    </div>
  </div>
  <div class="small" id="modeHint"></div>

  <label>ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ</label>
  <input type="file" accept="image/*">
  <div class="small">â€»ç”»åƒã¯ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆDrive / OneDrive ã«ä¿ç®¡ã—ã€ãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰</div>

  <label>ä¿å­˜å…ˆãƒªãƒ³ã‚¯ï¼ˆGoogle Drive / OneDriveï¼‰</label>
  <input id="link" placeholder="https://drive.google.com/...">
  <div class="small">â€»NASä¿å­˜ã¯éå¯¾å¿œï¼ˆNASå¸Œæœ›ã®å ´åˆã¯å½“ãƒ„ãƒ¼ãƒ«å¯¾è±¡å¤–ï¼‰</div>

  <label>ç”¨é€”</label>
  <select id="purpose">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="traffic">äº¤é€šè²»</option>
    <option value="stay">å®¿æ³Šè²»</option>
    <option value="supplies">æ¶ˆè€—å“</option>
    <option value="meeting">ä¼šè­°è²»</option>
    <option value="entertainment">äº¤éš›è²»</option>
  </select>

  <div id="stayFields" class="hidden">
    <label>æ³Šæ•°</label>
    <input id="nights" type="number" value="1" min="1">
  </div>

  <label>æ—¥ä»˜</label>
  <input id="date" type="date">

  <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
  <input id="amount" type="number" placeholder="AI ONãªã‚‰ç©ºã§ã‚‚OKï¼ˆå°†æ¥ï¼šè‡ªå‹•æŠ½å‡ºï¼‰">

  <div id="approvalFields" class="hidden">
    <label>
      <input type="checkbox" id="approved" style="width:auto;transform:scale(1.2);margin-right:8px">
      ä¸Šé•·ï¼ˆç¤¾é•·ï¼‰äº‹å‰æ‰¿èªã‚ã‚Š
    </label>
    <div class="small">â€»ä¼šè­°è²»/äº¤éš›è²»ï¼ˆï¼‹å¿…è¦ãªã‚‰å®¿æ³Šè²»ï¼‰ã¯äº‹å‰æ‰¿èªã®æœ‰ç„¡ã§åˆ¤å®šãŒå¤‰ã‚ã‚Šã¾ã™</div>
  </div>

  <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
  <input id="memo" placeholder="ä¾‹ï¼šâ—¯â—¯ç¤¾æ‰“åˆã› / â—¯â—¯ç¾å ´">

  <button class="primary" id="saveBtn">ä¿å­˜ã—ã¦åˆ¤å®š</button>
</div>

<div id="result" class="card hidden"></div>

<!-- Passcode dialog -->
<dialog id="passDlg">
  <div class="dlgHeader">
    <div style="font-weight:900">ğŸ”’ ç®¡ç†è€…èªè¨¼</div>
    <button class="ghost" id="closePassDlg" style="width:auto;padding:8px 10px">é–‰ã˜ã‚‹</button>
  </div>
  <div class="dlgBody">
    <div class="pill">è¨­å®šç”»é¢ã¯ç®¡ç†è€…ã®ã¿</div>

    <div id="firstSetupBlock" class="hidden">
      <label>åˆå›è¨­å®šï¼šç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
      <input id="newPass1" type="password" placeholder="ä¾‹ï¼š4ã€œ12æ¡ï¼ˆæ•°å­—æ¨å¥¨ï¼‰">
      <label>ç¢ºèª</label>
      <input id="newPass2" type="password" placeholder="åŒã˜ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦">
      <div class="small">â€»ã“ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã®PCã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚å¿˜ã‚Œã‚‹ã¨è¨­å®šå¤‰æ›´ãŒã§ãã¾ã›ã‚“ã€‚</div>
      <button class="primary" id="setPassBtn">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š</button>
    </div>

    <div id="loginBlock" class="hidden">
      <label>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
      <input id="passInput" type="password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button class="primary" id="unlockBtn">èªè¨¼ã—ã¦è¨­å®šã‚’é–‹ã</button>
      <div class="small">â€»ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã®PCå†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã§ç…§åˆã—ã¾ã™ã€‚</div>
    </div>

    <div id="passMsg" class="small"></div>
  </div>
</dialog>

<!-- Settings dialog -->
<dialog id="settingsDlg">
  <div class="dlgHeader">
    <div style="font-weight:900">âš™ï¸ ç¤¾å†…è¦å®š è¨­å®š</div>
    <button class="ghost" id="closeSettings" style="width:auto;padding:8px 10px">é–‰ã˜ã‚‹</button>
  </div>

  <div class="dlgBody">
    <div class="pill">ç¤¾é•·/äº‹å‹™é•·å‘ã‘ï¼šã“ã“ã§ç¤¾å†…ãƒ«ãƒ¼ãƒ«ã‚’å…¥åŠ›</div>

    <div class="kpi">
      <div>ä¿å­˜æ–¹å¼ï¼š<b>ã“ã®PCãƒ­ãƒ¼ã‚«ãƒ«</b></div>
      <div>ç®¡ç†ï¼š<b>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼</b></div>
      <div>NASï¼š<b class="dangerText">éå¯¾å¿œ</b></div>
    </div>

    <label>å®¿æ³Šè²» ä¸Šé™ï¼ˆ1æ³Šã‚ãŸã‚Šãƒ»å††ï¼‰</label>
    <input id="setStayLimit" type="number" min="0" placeholder="ä¾‹ï¼š10000">

    <label>å®¿æ³Šè²»ãŒä¸Šé™è¶…éã—ãŸå ´åˆã®æ‰±ã„</label>
    <select id="setStayOverAction">
      <option value="warn">ğŸŸ¡ è¦ç¢ºèª</option>
      <option value="danger">ğŸ”´ è¦å¯¾å¿œ</option>
    </select>

    <label>
      <input id="setStayApprovalRequired" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      å®¿æ³Šè²»ã¯äº‹å‰æ‰¿èªã‚’å¿…é ˆã«ã™ã‚‹
    </label>

    <label>
      <input id="setStayApprovedDowngrade" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      å®¿æ³Šè²»ï¼šä¸Šé™è¶…éã§ã‚‚ã€Œäº‹å‰æ‰¿èªã‚ã‚Šã€ãªã‚‰ğŸŸ¡ã«ã™ã‚‹
    </label>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <label>
      <input id="setMeetingApprovalRequired" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      ä¼šè­°è²»ã¯äº‹å‰æ‰¿èªã‚’å¿…é ˆã«ã™ã‚‹
    </label>

    <label>
      <input id="setEntertainmentApprovalRequired" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      äº¤éš›è²»ã¯äº‹å‰æ‰¿èªã‚’å¿…é ˆã«ã™ã‚‹
    </label>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <label>AIãƒ¢ãƒ¼ãƒ‰ï¼ˆMVPï¼šON/OFFã®ã¿ã€‚å‘¼ã³å‡ºã—ã¯å¾Œã§å·®ã—æ›¿ãˆï¼‰</label>
    <select id="setAiMode">
      <option value="off">AI OFFï¼ˆæ‰‹å…¥åŠ›ä¸­å¿ƒï¼‰</option>
      <option value="on">AI ONï¼ˆå°†æ¥ï¼šè‡ªå‹•æŠ½å‡º/ä¸€æ¬¡ãƒã‚§ãƒƒã‚¯ï¼‰</option>
    </select>

    <label>æœˆé–“AIåˆ©ç”¨ä¸Šé™ï¼ˆå›ï¼‰</label>
    <input id="setAiMonthlyLimit" type="number" min="0" placeholder="ä¾‹ï¼š200">

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <h1 style="font-size:16px;margin:0 0 6px">ğŸ§° è¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h1>
    <div class="small">ã“ã®PCã®è¨­å®šã‚’JSONã¨ã—ã¦ä¿å­˜/å¾©å…ƒã§ãã¾ã™ï¼ˆPCæ•…éšœãƒ»ãƒ–ãƒ©ã‚¦ã‚¶åˆæœŸåŒ–å¯¾ç­–ï¼‰ã€‚</div>

    <div class="row" style="margin-top:8px">
      <button class="ghost" id="exportSettingsBtn">â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONä¿å­˜ï¼‰</button>
      <button class="ghost" id="showImportAreaBtn">â¬†ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONèª­ã¿è¾¼ã¿ï¼‰</button>
    </div>

    <div id="importArea" class="hidden" style="margin-top:10px">
      <label>JSONã‚’è²¼ã‚Šä»˜ã‘</label>
      <textarea id="importJson" class="mono" placeholder='{"stayLimit":10000,...}'></textarea>
      <div class="row">
        <button class="primary" id="importFromTextBtn">ã“ã®JSONã§å¾©å…ƒ</button>
        <button class="ghost" id="hideImportAreaBtn">é–‰ã˜ã‚‹</button>
      </div>

      <label>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</label>
      <input id="importFile" type="file" accept="application/json">
      <div class="small">â€»ä¼šç¤¾å†…å…±æœ‰ã™ã‚‹ãªã‚‰ã€ã“ã“ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã£ã¦èª­ã¿è¾¼ã‚€ã®ãŒä¸€ç•ªç°¡å˜ã§ã™ã€‚</div>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <h1 style="font-size:16px;margin:0 0 6px">ğŸ”‘ ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</h1>
    <div class="row">
      <button class="ghost" id="changePassBtn">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</button>
      <button class="ghost" id="clearPassBtn" title="æœ€å¾Œã®æ‰‹æ®µï¼ˆè¨­å®šãŒè§¦ã‚Œãªããªã‚Šã¾ã™ï¼‰">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å‰Šé™¤</button>
    </div>
    <div class="small dangerText">â€»å‰Šé™¤ã™ã‚‹ã¨æ¬¡å›ã€Œåˆå›è¨­å®šã€ã‹ã‚‰ã‚„ã‚Šç›´ã—ã«ãªã‚Šã¾ã™ã€‚æ…é‡ã«ã€‚</div>

    <div class="small">
      â€»æœ¬ãƒ„ãƒ¼ãƒ«ã¯ç¤¾å†…è¦å®šã«åŸºã¥ãäº‹å‰ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚ç¨å‹™ä¸Šã®æœ€çµ‚åˆ¤æ–­ã¯é¡§å•ç¨ç†å£«ã«ã”ç¢ºèªãã ã•ã„ã€‚<br>
      â€»NASä¿ç®¡ã¯éå¯¾å¿œï¼ˆNASå¸Œæœ›ã®å ´åˆã¯å½“ãƒ„ãƒ¼ãƒ«å¯¾è±¡å¤–ï¼‰ã€‚<br>
    </div>

    <div id="settingsMsg" class="small"></div>
  </div>

  <div class="dlgFooter">
    <button class="primary" id="saveSettings">è¨­å®šã‚’ä¿å­˜</button>
    <button class="ghost" id="resetSettings">åˆæœŸå€¤ã«æˆ»ã™</button>
  </div>
</dialog>

<!-- Change pass dialog -->
<dialog id="changePassDlg">
  <div class="dlgHeader">
    <div style="font-weight:900">ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</div>
    <button class="ghost" id="closeChangePassDlg" style="width:auto;padding:8px 10px">é–‰ã˜ã‚‹</button>
  </div>
  <div class="dlgBody">
    <label>ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
    <input id="curPass" type="password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰">

    <label>æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
    <input id="chgPass1" type="password" placeholder="4ã€œ12æ¡ï¼ˆæ•°å­—æ¨å¥¨ï¼‰">

    <label>ç¢ºèª</label>
    <input id="chgPass2" type="password" placeholder="åŒã˜ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦">

    <button class="primary" id="applyPassChangeBtn">å¤‰æ›´ã™ã‚‹</button>
    <div id="chgMsg" class="small"></div>
  </div>
</dialog>

<script>
/** ========= Storage keys ========= */
const LS_SETTINGS = "nc_expense_settings_v2";
const LS_PASS_HASH = "nc_admin_pass_hash_v1";
const LS_UNLOCKED = "nc_admin_unlocked_v1"; // session

/** ========= Defaults ========= */
const DEFAULT_SETTINGS = {
  stayLimit: 10000,
  stayOverAction: "warn",             // warn | danger
  stayApprovalRequired: false,
  stayApprovedDowngrade: true,
  meetingApprovalRequired: true,
  entertainmentApprovalRequired: true,
  aiMode: "off",                      // off | on (placeholder)
  aiMonthlyLimit: 200
};

/** ========= Helpers ========= */
function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS);
    if(!raw) return {...DEFAULT_SETTINGS};
    const s = JSON.parse(raw);
    return {...DEFAULT_SETTINGS, ...s};
  }catch{
    return {...DEFAULT_SETTINGS};
  }
}
function storeSettings(s){
  localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

/** ========= Passcode hashing (lightweight) =========
 * ç›®çš„ï¼šå¹³æ–‡ã‚’localStorageã«ç½®ã‹ãªã„ãŸã‚ã®æœ€ä½é™ã€‚
 * â€»æœ¬æ ¼çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå¿…è¦ãªã‚‰ã‚µãƒ¼ãƒæ–¹å¼ã¸ã€‚
 */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function hasPasscode(){
  return !!localStorage.getItem(LS_PASS_HASH);
}
function isUnlocked(){
  return sessionStorage.getItem(LS_UNLOCKED) === "1";
}
function setUnlocked(v){
  sessionStorage.setItem(LS_UNLOCKED, v ? "1" : "0");
}

/** ========= Relax tips ========= */
const relaxTips = [
  "ğŸŒ¬ æ·±å‘¼å¸ã‚’3å›ã€‚é¼»ã‹ã‚‰å¸ã£ã¦ã€å£ã‹ã‚‰ã‚†ã£ãã‚Š",
  "ğŸ’§ æ°´ã‚’ä¸€å£é£²ã‚“ã§ã€è‚©ã®åŠ›ã‚’æŠœã“ã†",
  "ğŸ‘€ ç›®ã‚’é–‰ã˜ã¦10ç§’ã€‚ç”»é¢ã‹ã‚‰ç›®ã‚’é›¢ãã†",
  "ğŸ™†â€â™‚ï¸ å¤§ããèƒŒä¼¸ã³ã—ã¦ã¿ã‚ˆã†",
  "ğŸŒ€ é¦–ã‚„è‚©ã‚’ã‚†ã£ãã‚Šå›ã—ã¦ã¿ã‚ˆã†",
  "ğŸš¶ å¤–ã®ç©ºæ°—ã‚’å¸ã„ã«è¡Œã“ã†",
  "ğŸªŸ çª“ã®å¤–ã‚’10ç§’çœºã‚ã¦ã¿ã‚ˆã†"
];
function pickRelax(){
  return relaxTips[Math.floor(Math.random()*relaxTips.length)];
}

/** ========= Main UI wiring ========= */
let settings = loadSettings();

const purposeEl = document.getElementById("purpose");
const stayFields = document.getElementById("stayFields");
const approvalFields = document.getElementById("approvalFields");
const amountEl = document.getElementById("amount");
const nightsEl = document.getElementById("nights");
const approvedEl = document.getElementById("approved");
const linkEl = document.getElementById("link");
const dateEl = document.getElementById("date");
const modeHint = document.getElementById("modeHint");

function updateModeHint(){
  const ai = settings.aiMode === "on";
  modeHint.textContent = ai
    ? "ğŸ§  ç¾åœ¨ï¼šAI ONï¼ˆå°†æ¥ã“ã“ã«è‡ªå‹•æŠ½å‡ºã‚’è¿½åŠ ï¼‰"
    : "âœï¸ ç¾åœ¨ï¼šAI OFFï¼ˆæ‰‹å…¥åŠ›ä¸­å¿ƒï¼‰";
  amountEl.placeholder = ai ? "AI ONãªã‚‰ç©ºã§ã‚‚OKï¼ˆå°†æ¥ï¼šè‡ªå‹•æŠ½å‡ºï¼‰" : "æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„";
}
updateModeHint();

// default date = today
(function initDate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  dateEl.value = `${y}-${m}-${day}`;
})();

purposeEl.onchange = () => {
  const v = purposeEl.value;
  stayFields.classList.toggle("hidden", v !== "stay");
  const showApproval = ["meeting","entertainment","stay"].includes(v);
  approvalFields.classList.toggle("hidden", !showApproval);
};

function badge(status){
  if(status==="ok") return `<span class="badge ok">ğŸŸ¢ å•é¡Œãªã—</span>`;
  if(status==="warn") return `<span class="badge warn">ğŸŸ¡ è¦ç¢ºèª</span>`;
  return `<span class="badge danger">ğŸ”´ è¦å¯¾å¿œ</span>`;
}

function evaluate(){
  const purpose = purposeEl.value;
  const amount = Number(amountEl.value || 0);
  const nights = Math.max(1, Number(nightsEl.value || 1));
  const approved = !!approvedEl.checked;

  let status = "ok";
  let reasons = [];

  // Approval requirements
  if(purpose === "meeting" && settings.meetingApprovalRequired && !approved){
    status = "danger";
    reasons.push("ä¼šè­°è²»ï¼šäº‹å‰æ‰¿èªãŒã‚ã‚Šã¾ã›ã‚“");
  }
  if(purpose === "entertainment" && settings.entertainmentApprovalRequired && !approved){
    status = "danger";
    reasons.push("äº¤éš›è²»ï¼šäº‹å‰æ‰¿èªãŒã‚ã‚Šã¾ã›ã‚“");
  }
  if(purpose === "stay" && settings.stayApprovalRequired && !approved){
    status = "danger";
    reasons.push("å®¿æ³Šè²»ï¼šäº‹å‰æ‰¿èªãŒã‚ã‚Šã¾ã›ã‚“");
  }

  // Stay limit check
  if(purpose === "stay" && amount > 0){
    const perNight = amount / nights;
    if(perNight > settings.stayLimit){
      let act = settings.stayOverAction; // warn|danger
      if(approved && settings.stayApprovedDowngrade) act = "warn";
      if(status !== "danger") status = act;
      reasons.push(`å®¿æ³Šè²»ï¼š${Math.round(perNight)}å††/æ³Šï¼ˆä¸Šé™${settings.stayLimit}å††è¶…ï¼‰`);
    }
  }

  // Date age hint
  const d = new Date(dateEl.value);
  if(!isNaN(d.getTime())){
    const days = Math.floor((Date.now() - d.getTime()) / (1000*60*60*24));
    if(days > 90){
      status = "danger";
      reasons.push("æ—¥ä»˜ï¼š3ã‹æœˆä»¥ä¸Šå‰ï¼ˆè¦å¯¾å¿œï¼‰");
    }else if(days > 60 && status === "ok"){
      status = "warn";
      reasons.push("æ—¥ä»˜ï¼š2ã‹æœˆä»¥ä¸Šå‰ï¼ˆè¦ç¢ºèªï¼‰");
    }
  }

  // Amount required if AI OFF
  if(settings.aiMode !== "on" && !amount){
    status = "danger";
    reasons.push("é‡‘é¡ãŒæœªå…¥åŠ›ã§ã™ï¼ˆAI OFFã§ã¯å¿…é ˆï¼‰");
  }

  return {status, reasons};
}

document.getElementById("saveBtn").onclick = () => {
  const link = linkEl.value.trim();
  if(!link){ alert("ä¿å­˜å…ˆãƒªãƒ³ã‚¯ã¯å¿…é ˆã§ã™"); return; }
  if(!purposeEl.value){ alert("ç”¨é€”ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

  const {status, reasons} = evaluate();
  const relax = pickRelax();

  const r = document.getElementById("result");
  r.classList.remove("hidden");
  r.innerHTML = `
    <h1>åˆ¤å®šçµæœ</h1>
    ${badge(status)}
    ${reasons.length ? `<ul>${reasons.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : `<div class="small">ï¼ˆç‰¹ã«æŒ‡æ‘˜ãªã—ï¼‰</div>`}
    <div class="relax">
      ğŸ«¶ <strong>30ç§’ãŠã™ã™ã‚ãƒªãƒ©ãƒƒã‚¯ã‚¹</strong><br>
      ä»Šæ—¥ã®ãƒ’ãƒ³ãƒˆï¼š ${escapeHtml(relax)}
    </div>
  `;
};

/** ========= Settings UI ========= */
const settingsDlg = document.getElementById("settingsDlg");
const passDlg = document.getElementById("passDlg");
const changePassDlg = document.getElementById("changePassDlg");

function fillSettingsUI(s){
  document.getElementById("setStayLimit").value = s.stayLimit;
  document.getElementById("setStayOverAction").value = s.stayOverAction;
  document.getElementById("setStayApprovalRequired").checked = !!s.stayApprovalRequired;
  document.getElementById("setStayApprovedDowngrade").checked = !!s.stayApprovedDowngrade;
  document.getElementById("setMeetingApprovalRequired").checked = !!s.meetingApprovalRequired;
  document.getElementById("setEntertainmentApprovalRequired").checked = !!s.entertainmentApprovalRequired;
  document.getElementById("setAiMode").value = s.aiMode;
  document.getElementById("setAiMonthlyLimit").value = s.aiMonthlyLimit;
  document.getElementById("settingsMsg").textContent = "";
}

function collectSettingsUI(){
  const stayLimit = Number(document.getElementById("setStayLimit").value || 0);
  if(stayLimit < 0) throw new Error("å®¿æ³Šè²»ä¸Šé™ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");

  return {
    stayLimit: stayLimit || DEFAULT_SETTINGS.stayLimit,
    stayOverAction: document.getElementById("setStayOverAction").value,
    stayApprovalRequired: document.getElementById("setStayApprovalRequired").checked,
    stayApprovedDowngrade: document.getElementById("setStayApprovedDowngrade").checked,
    meetingApprovalRequired: document.getElementById("setMeetingApprovalRequired").checked,
    entertainmentApprovalRequired: document.getElementById("setEntertainmentApprovalRequired").checked,
    aiMode: document.getElementById("setAiMode").value,
    aiMonthlyLimit: Number(document.getElementById("setAiMonthlyLimit").value || DEFAULT_SETTINGS.aiMonthlyLimit)
  };
}

/** ========= Passcode flow ========= */
document.getElementById("openSettings").onclick = async () => {
  if(isUnlocked()){
    // already unlocked in this session
    fillSettingsUI(loadSettings());
    settingsDlg.showModal();
    return;
  }

  // show pass dialog (first setup or login)
  const has = await hasPasscode();
  document.getElementById("firstSetupBlock").classList.toggle("hidden", has);
  document.getElementById("loginBlock").classList.toggle("hidden", !has);
  document.getElementById("passMsg").textContent = "";
  passDlg.showModal();
};

document.getElementById("closePassDlg").onclick = () => passDlg.close();

document.getElementById("setPassBtn").onclick = async () => {
  const p1 = (document.getElementById("newPass1").value || "").trim();
  const p2 = (document.getElementById("newPass2").value || "").trim();
  const msg = document.getElementById("passMsg");
  msg.textContent = "";

  if(p1.length < 4 || p1.length > 12){
    msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯4ã€œ12æ–‡å­—ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  if(p1 !== p2){
    msg.textContent = "ç¢ºèªç”¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚";
    return;
  }
  const h = await sha256Hex(p1);
  localStorage.setItem(LS_PASS_HASH, h);
  setUnlocked(true);
  msg.textContent = "âœ… ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸã€‚è¨­å®šç”»é¢ã‚’é–‹ãã¾ã™ã€‚";

  // open settings
  passDlg.close();
  fillSettingsUI(loadSettings());
  settingsDlg.showModal();
};

document.getElementById("unlockBtn").onclick = async () => {
  const input = (document.getElementById("passInput").value || "").trim();
  const msg = document.getElementById("passMsg");
  msg.textContent = "";

  const saved = localStorage.getItem(LS_PASS_HASH);
  if(!saved){
    msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæœªè¨­å®šã§ã™ã€‚";
    return;
  }
  const h = await sha256Hex(input);
  if(h !== saved){
    msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
    return;
  }
  setUnlocked(true);
  passDlg.close();
  fillSettingsUI(loadSettings());
  settingsDlg.showModal();
};

/** ========= Settings dialog buttons ========= */
document.getElementById("closeSettings").onclick = () => settingsDlg.close();

document.getElementById("saveSettings").onclick = () => {
  try{
    const s = collectSettingsUI();
    storeSettings(s);
    settings = loadSettings();
    updateModeHint();
    document.getElementById("settingsMsg").textContent = "âœ… ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰";
  }catch(e){
    alert(e.message);
  }
};

document.getElementById("resetSettings").onclick = () => {
  storeSettings({...DEFAULT_SETTINGS});
  settings = loadSettings();
  fillSettingsUI(settings);
  updateModeHint();
  document.getElementById("settingsMsg").textContent = "â†© åˆæœŸå€¤ã«æˆ»ã—ã¾ã—ãŸ";
};

/** ========= Export / Import ========= */
document.getElementById("exportSettingsBtn").onclick = () => {
  const s = loadSettings();
  const stamp = new Date().toISOString().slice(0,10);
  downloadText(`expense-settings-${stamp}.json`, JSON.stringify(s, null, 2));
  document.getElementById("settingsMsg").textContent = "â¬‡ï¸ è¨­å®šJSONã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚";
};

document.getElementById("showImportAreaBtn").onclick = () => {
  document.getElementById("importArea").classList.remove("hidden");
};
document.getElementById("hideImportAreaBtn").onclick = () => {
  document.getElementById("importArea").classList.add("hidden");
};

document.getElementById("importFromTextBtn").onclick = () => {
  try{
    const txt = document.getElementById("importJson").value.trim();
    if(!txt) { alert("JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return; }
    const obj = JSON.parse(txt);
    // Merge with defaults to avoid missing keys
    const merged = {...DEFAULT_SETTINGS, ...obj};
    storeSettings(merged);
    settings = loadSettings();
    fillSettingsUI(settings);
    updateModeHint();
    document.getElementById("settingsMsg").textContent = "âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦å¾©å…ƒã—ã¾ã—ãŸã€‚";
  }catch(e){
    alert("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼š\n" + e.message);
  }
};

document.getElementById("importFile").addEventListener("change", async (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    const merged = {...DEFAULT_SETTINGS, ...obj};
    storeSettings(merged);
    settings = loadSettings();
    fillSettingsUI(settings);
    updateModeHint();
    document.getElementById("settingsMsg").textContent = "âœ… JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚";
    ev.target.value = "";
  }catch(e){
    alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š\n" + e.message);
  }
});

/** ========= Passcode change / clear ========= */
document.getElementById("changePassBtn").onclick = () => {
  document.getElementById("curPass").value = "";
  document.getElementById("chgPass1").value = "";
  document.getElementById("chgPass2").value = "";
  document.getElementById("chgMsg").textContent = "";
  changePassDlg.showModal();
};
document.getElementById("closeChangePassDlg").onclick = () => changePassDlg.close();

document.getElementById("applyPassChangeBtn").onclick = async () => {
  const cur = (document.getElementById("curPass").value || "").trim();
  const p1 = (document.getElementById("chgPass1").value || "").trim();
  const p2 = (document.getElementById("chgPass2").value || "").trim();
  const msg = document.getElementById("chgMsg");
  msg.textContent = "";

  const saved = localStorage.getItem(LS_PASS_HASH);
  if(!saved){ msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæœªè¨­å®šã§ã™ã€‚"; return; }

  const curH = await sha256Hex(cur);
  if(curH !== saved){ msg.textContent = "ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚"; return; }

  if(p1.length < 4 || p1.length > 12){
    msg.textContent = "æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯4ã€œ12æ–‡å­—ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  if(p1 !== p2){
    msg.textContent = "ç¢ºèªç”¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚";
    return;
  }
  const newH = await sha256Hex(p1);
  localStorage.setItem(LS_PASS_HASH, newH);
  msg.textContent = "âœ… ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚";
};

document.getElementById("clearPassBtn").onclick = () => {
  const ok = confirm("ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\næ¬¡å›ä»¥é™ã€è¨­å®šå¤‰æ›´ã«ã¯å†åº¦ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚");
  if(!ok) return;
  localStorage.removeItem(LS_PASS_HASH);
  setUnlocked(false);
  alert("ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚æ¬¡å›ã¯åˆå›è¨­å®šã‹ã‚‰ã«ãªã‚Šã¾ã™ã€‚");
};
</script>
</body>
</html>
