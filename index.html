<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>çµŒè²»ç™»éŒ²ï¼ˆ30ç§’ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0}
  .card{background:#fff;margin:12px;padding:16px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1;min-width:160px}
  h1{font-size:18px;margin:0 0 12px}
  label{font-weight:650;display:block;margin-top:12px}
  input,select,button,textarea{width:100%;padding:10px;margin-top:6px;font-size:14px;box-sizing:border-box}
  textarea{min-height:120px;resize:vertical}
  button{border:none;border-radius:10px}
  .primary{background:#2563eb;color:#fff;font-size:16px;margin-top:16px}
  .ghost{background:#e5e7eb}
  .badge{display:inline-block;padding:6px 10px;border-radius:8px;font-size:13px;margin-top:8px}
  .ok{background:#16a34a;color:#fff}
  .warn{background:#facc15}
  .danger{background:#dc2626;color:#fff}
  .hidden{display:none}
  .small{font-size:12px;color:#6b7280;margin-top:6px;line-height:1.45}
  .relax{margin-top:16px;padding:12px;border-radius:10px;background:#f0f9ff;font-size:14px}
  .topbar{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .topbar .title{font-weight:800}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1e40af;font-size:12px}
  dialog{width:min(760px,95vw);border:none;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .dlgHeader{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .dlgBody{padding:14px 16px}
  .dlgFooter{padding:14px 16px;border-top:1px solid #e5e7eb;display:flex;gap:10px;flex-wrap:wrap}
  .dangerText{color:#b91c1c;font-weight:800}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .kpi > div{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .readonlyBox{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px}
</style>
</head>
<body>

<div class="card">
  <div class="topbar">
    <div class="title">ğŸ“¸ çµŒè²»ç™»éŒ²ï¼ˆ30ç§’ï¼‰</div>
    <div class="row" style="flex:0 0 auto; gap:8px">
      <button id="openSettings" class="ghost" style="width:auto;padding:10px 12px">âš™ï¸ è¨­å®š</button>
    </div>
  </div>
  <div class="small" id="modeHint"></div>

  <!-- ç®¡ç†è€…æŒ‡å®šã®ä¿å­˜å…ˆï¼ˆå–¶æ¥­ã¯é–²è¦§ã®ã¿ï¼‰ -->
  <div class="readonlyBox" style="margin-top:12px">
    <div style="font-weight:800">ğŸ“ ä¿å­˜å…ˆï¼ˆç¤¾å†…æŒ‡å®šï¼‰</div>
    <div class="small" id="folderHint">æœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ãŒâš™ï¸è¨­å®šã§ä¿å­˜å…ˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</div>
    <div class="row" style="margin-top:8px">
      <button id="copyFolderBtn" class="ghost" style="flex:0 0 auto; width:auto; padding:10px 12px">ã‚³ãƒ”ãƒ¼</button>
      <button id="openFolderBtn" class="ghost" style="flex:0 0 auto; width:auto; padding:10px 12px">é–‹ã</button>
    </div>
    <div class="small">â€»ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒï¼ˆè¨¼æ†‘ï¼‰ã¯ä¸Šè¨˜ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆDrive/OneDriveæ¨å¥¨ï¼‰ã¸ä¿å­˜ã—ã€å…±æœ‰ãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ãã ã•ã„ã€‚</div>
  </div>

  <label>ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒURLï¼ˆå¿…é ˆï¼‰</label>
  <input id="imageUrl" placeholder="ä¾‹ï¼šhttps://drive.google.com/...  ã¾ãŸã¯ https://1drv.ms/...">
  <div class="small">â€»æœ¬ãƒ„ãƒ¼ãƒ«ã¯ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã›ã‚“ã€‚å…ˆã«ç¤¾å†…æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã¸ä¿å­˜ã—ã€å…±æœ‰ãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ãã ã•ã„ã€‚</div>

  <label>ç”¨é€”</label>
  <select id="purpose">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="traffic">äº¤é€šè²»</option>
    <option value="stay">å®¿æ³Šè²»</option>
    <option value="supplies">æ¶ˆè€—å“</option>
    <option value="meeting">ä¼šè­°è²»</option>
    <option value="entertainment">äº¤éš›è²»</option>
  </select>

  <div id="stayFields" class="hidden">
    <label>æ³Šæ•°</label>
    <input id="nights" type="number" value="1" min="1">
  </div>

  <label>æ—¥ä»˜</label>
  <input id="date" type="date">

  <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
  <input id="amount" type="number" placeholder="æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„">

  <div id="approvalFields" class="hidden">
    <label>
      <input type="checkbox" id="approved" style="width:auto;transform:scale(1.2);margin-right:8px">
      ä¸Šé•·ï¼ˆç¤¾é•·ï¼‰äº‹å‰æ‰¿èªã‚ã‚Š
    </label>
    <div class="small">â€»ä¼šè­°è²»/äº¤éš›è²»ï¼ˆï¼‹å¿…è¦ãªã‚‰å®¿æ³Šè²»ï¼‰ã¯äº‹å‰æ‰¿èªã®æœ‰ç„¡ã§åˆ¤å®šãŒå¤‰ã‚ã‚Šã¾ã™</div>
  </div>

  <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
  <input id="memo" placeholder="ä¾‹ï¼šâ—¯â—¯ç¤¾æ‰“åˆã› / â—¯â—¯ç¾å ´">

  <button class="primary" id="saveBtn">åˆ¤å®šã—ã¦CSVã‚’ä½œæˆ</button>

  <div class="small" style="margin-top:10px">
    âœ… <b>å–¶æ¥­å‘ã‘æ³¨æ„</b>ï¼šä½œæˆã—ãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ç¤¾å†…è¦å®šã®ä¿ç®¡å ´æ‰€ã¾ãŸã¯è²¬ä»»è€…ã®æŒ‡å®šã™ã‚‹ä¿ç®¡å ´æ‰€ã¸æ ¼ç´ã—ã¦ãã ã•ã„ã€‚
  </div>

  <div class="small dangerText" style="margin-top:10px">
    â€»æœ¬ãƒ„ãƒ¼ãƒ«ã¯ç¤¾å†…è¦å®šã«åŸºã¥ãäº‹å‰ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚ç¨å‹™ä¸Šã®æœ€çµ‚åˆ¤æ–­ã¯é¡§å•ç¨ç†å£«ã«ã”ç¢ºèªãã ã•ã„ã€‚
  </div>
</div>

<div id="result" class="card hidden"></div>

<!-- Passcode dialog -->
<dialog id="passDlg">
  <div class="dlgHeader">
    <div style="font-weight:900">ğŸ”’ ç®¡ç†è€…èªè¨¼</div>
    <button class="ghost" id="closePassDlg" style="width:auto;padding:8px 10px">é–‰ã˜ã‚‹</button>
  </div>
  <div class="dlgBody">
    <div class="pill">è¨­å®šç”»é¢ã¯ç®¡ç†è€…ã®ã¿</div>

    <div class="small" style="margin-top:10px">
      âš ï¸ <b>é‡è¦ãªãŠçŸ¥ã‚‰ã›</b><br>
      æœ¬ãƒ„ãƒ¼ãƒ«ã§ã¯ã€ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŠã‚ˆã³è¨­å®šæƒ…å ±ã‚’å½“ç¤¾ã§ã¯ä¸€åˆ‡ä¿å­˜ã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚<br>
      ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŠã‚ˆã³è¨­å®šæƒ…å ±ã¯ã€ç®¡ç†è€…ãŒä½¿ç”¨ã™ã‚‹PCã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
      ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç´›å¤±ã—ãŸå ´åˆã€è¨­å®šå¤‰æ›´ãŒã§ãã¾ã›ã‚“ã®ã§ç®¡ç†ã«ã”æ³¨æ„ãã ã•ã„ã€‚
    </div>

    <div id="firstSetupBlock" class="hidden">
      <label>åˆå›è¨­å®šï¼šç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
      <input id="newPass1" type="password" placeholder="ä¾‹ï¼š4ã€œ12æ–‡å­—ï¼ˆæ•°å­—æ¨å¥¨ï¼‰">
      <label>ç¢ºèª</label>
      <input id="newPass2" type="password" placeholder="åŒã˜ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦">
      <button class="primary" id="setPassBtn">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š</button>
    </div>

    <div id="loginBlock" class="hidden">
      <label>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
      <input id="passInput" type="password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button class="primary" id="unlockBtn">èªè¨¼ã—ã¦è¨­å®šã‚’é–‹ã</button>
    </div>

    <div id="passMsg" class="small"></div>
  </div>
</dialog>

<!-- Settings dialog -->
<dialog id="settingsDlg">
  <div class="dlgHeader">
    <div style="font-weight:900">âš™ï¸ ç¤¾å†…è¦å®š è¨­å®š</div>
    <button class="ghost" id="closeSettings" style="width:auto;padding:8px 10px">é–‰ã˜ã‚‹</button>
  </div>

  <div class="dlgBody">
    <div class="pill">ç¤¾é•·/äº‹å‹™é•·å‘ã‘ï¼šã“ã“ã§ç¤¾å†…ãƒ«ãƒ¼ãƒ«ã‚’å…¥åŠ›</div>

    <div class="kpi">
      <div>ä¿å­˜æ–¹å¼ï¼š<b>ã“ã®PCãƒ­ãƒ¼ã‚«ãƒ«</b></div>
      <div>ç®¡ç†ï¼š<b>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼</b></div>
      <div>è¨¼æ†‘ï¼š<b>Drive/OneDriveæ¨å¥¨</b></div>
      <div>CSVï¼š<b>ç¤¾å†…è¦å®šï¼ˆNASå¯ï¼‰</b></div>
    </div>

    <label>ç¤¾å†…æŒ‡å®šã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URLï¼ˆDrive/OneDriveï¼‰</label>
    <input id="setFolderUrl" placeholder="ä¾‹ï¼šhttps://drive.google.com/drive/folders/xxxx ã¾ãŸã¯ https://...sharepoint.com/...">
    <div class="small">â€»å–¶æ¥­ã¯ã“ã®ä¿å­˜å…ˆã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚ã€Œã“ã“ã«ä¸Šã’ã‚ã‚„ï¼ã€ã‚’å›ºå®šã§ãã¾ã™ã€‚</div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <label>å®¿æ³Šè²» ä¸Šé™ï¼ˆ1æ³Šã‚ãŸã‚Šãƒ»å††ï¼‰</label>
    <input id="setStayLimit" type="number" min="0" placeholder="ä¾‹ï¼š10000">

    <label>å®¿æ³Šè²»ãŒä¸Šé™è¶…éã—ãŸå ´åˆã®æ‰±ã„</label>
    <select id="setStayOverAction">
      <option value="warn">ğŸŸ¡ è¦ç¢ºèª</option>
      <option value="danger">ğŸ”´ è¦å¯¾å¿œ</option>
    </select>

    <label>
      <input id="setStayApprovalRequired" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      å®¿æ³Šè²»ã¯äº‹å‰æ‰¿èªã‚’å¿…é ˆã«ã™ã‚‹
    </label>

    <label>
      <input id="setStayApprovedDowngrade" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      å®¿æ³Šè²»ï¼šä¸Šé™è¶…éã§ã‚‚ã€Œäº‹å‰æ‰¿èªã‚ã‚Šã€ãªã‚‰ğŸŸ¡ã«ã™ã‚‹
    </label>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <label>
      <input id="setMeetingApprovalRequired" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      ä¼šè­°è²»ã¯äº‹å‰æ‰¿èªã‚’å¿…é ˆã«ã™ã‚‹
    </label>

    <label>
      <input id="setEntertainmentApprovalRequired" type="checkbox" style="width:auto;transform:scale(1.2);margin-right:8px">
      äº¤éš›è²»ã¯äº‹å‰æ‰¿èªã‚’å¿…é ˆã«ã™ã‚‹
    </label>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <h1 style="font-size:16px;margin:0 0 6px">ğŸ“„ CSVã²ãªå½¢</h1>
    <div class="small">äº‹å‹™å´ã®é›†ç´„ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ã§ã™ï¼ˆãƒ˜ãƒƒãƒ€ã®ã¿ï¼‰ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã®ã€ŒCSVä½œæˆã€ã¯ã“ã®åˆ—é †ã§å‡ºåŠ›ã—ã¾ã™ã€‚</div>
    <button class="ghost" id="downloadTemplateBtn">â¬‡ï¸ CSVã²ãªå½¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0">

    <h1 style="font-size:16px;margin:0 0 6px">ğŸ”‘ ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</h1>
    <div class="row">
      <button class="ghost" id="changePassBtn">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</button>
      <button class="ghost" id="clearPassBtn" title="æœ€å¾Œã®æ‰‹æ®µ">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å‰Šé™¤</button>
    </div>
    <div class="small dangerText">â€»å‰Šé™¤ã™ã‚‹ã¨æ¬¡å›ã€Œåˆå›è¨­å®šã€ã‹ã‚‰ã‚„ã‚Šç›´ã—ã«ãªã‚Šã¾ã™ã€‚æ…é‡ã«ã€‚</div>

    <div class="small">
      â€»æœ¬ãƒ„ãƒ¼ãƒ«ã¯ç¤¾å†…è¦å®šã«åŸºã¥ãäº‹å‰ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚ç¨å‹™ä¸Šã®æœ€çµ‚åˆ¤æ–­ã¯é¡§å•ç¨ç†å£«ã«ã”ç¢ºèªãã ã•ã„ã€‚<br>
    </div>

    <div id="settingsMsg" class="small"></div>
  </div>

  <div class="dlgFooter">
    <button class="primary" id="saveSettings">è¨­å®šã‚’ä¿å­˜</button>
    <button class="ghost" id="resetSettings">åˆæœŸå€¤ã«æˆ»ã™</button>
  </div>
</dialog>

<!-- Change pass dialog -->
<dialog id="changePassDlg">
  <div class="dlgHeader">
    <div style="font-weight:900">ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´</div>
    <button class="ghost" id="closeChangePassDlg" style="width:auto;padding:8px 10px">é–‰ã˜ã‚‹</button>
  </div>
  <div class="dlgBody">
    <label>ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
    <input id="curPass" type="password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰">

    <label>æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</label>
    <input id="chgPass1" type="password" placeholder="4ã€œ12æ–‡å­—ï¼ˆæ•°å­—æ¨å¥¨ï¼‰">

    <label>ç¢ºèª</label>
    <input id="chgPass2" type="password" placeholder="åŒã˜ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦">

    <button class="primary" id="applyPassChangeBtn">å¤‰æ›´ã™ã‚‹</button>
    <div id="chgMsg" class="small"></div>
  </div>
</dialog>

<script>
/** ========= Storage keys ========= */
const LS_SETTINGS = "nc_keihi_settings_v1";
const LS_PASS_HASH = "nc_keihi_admin_pass_hash_v1";
const LS_UNLOCKED = "nc_keihi_admin_unlocked_session_v1";

/** ========= CSV header (template) ========= */
const CSV_HEADER = [
  "ç”³è«‹ID","ç”»åƒç•ªå·","ç”»åƒURL","æ—¥ä»˜","ç”¨é€”","é‡‘é¡","æ³Šæ•°","äº‹å‰æ‰¿èª","ãƒ¡ãƒ¢","åˆ¤å®š","åˆ¤å®šç†ç”±",
  "å‹˜å®šç§‘ç›®","è£œåŠ©ç§‘ç›®","éƒ¨é–€","å–å¼•å…ˆ/ç›¸æ‰‹å…ˆ","ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ç¾å ´ã‚³ãƒ¼ãƒ‰","ç¨åŒºåˆ†","ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ç•ªå·","é©æ ¼è«‹æ±‚æ›¸ãƒ•ãƒ©ã‚°",
  "äº‹å‹™ç¢ºèª","äº‹å‹™ç¢ºèªæ—¥","å·®æˆ»ç†ç”±","æ‰¿èªè€…","æ‰¿èªæ—¥",
  "è¿½åŠ é …ç›®1_åç§°","è¿½åŠ é …ç›®1_å€¤","è¿½åŠ é …ç›®2_åç§°","è¿½åŠ é …ç›®2_å€¤","è¿½åŠ é …ç›®3_åç§°","è¿½åŠ é …ç›®3_å€¤"
];

/** ========= Defaults ========= */
const DEFAULT_SETTINGS = {
  folderUrl: "",
  stayLimit: 10000,
  stayOverAction: "warn",             // warn | danger
  stayApprovalRequired: false,
  stayApprovedDowngrade: true,
  meetingApprovalRequired: true,
  entertainmentApprovalRequired: true
};

/** ========= Helpers ========= */
function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS);
    if(!raw) return {...DEFAULT_SETTINGS};
    const s = JSON.parse(raw);
    return {...DEFAULT_SETTINGS, ...s};
  }catch{
    return {...DEFAULT_SETTINGS};
  }
}
function storeSettings(s){
  localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function downloadText(filename, text, mime="text/plain"){
  const blob = new Blob([text], {type:mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function toCsvRow(values){
  return values.map(v=>{
    const s = (v===null||v===undefined) ? "" : String(v);
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(",");
}
function nowJstStamp(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  return `${y}${m}${day}-${hh}${mm}${ss}`;
}
function makeApplicationId(){
  const stamp = nowJstStamp();
  const rand = Math.floor(Math.random()*10000).toString().padStart(4,"0");
  return `EXP-${stamp}-${rand}`;
}
function setClipboard(text){
  return navigator.clipboard?.writeText(text);
}

/** ========= Passcode hashing ========= */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function hasPasscode(){ return !!localStorage.getItem(LS_PASS_HASH); }
function isUnlocked(){ return sessionStorage.getItem(LS_UNLOCKED) === "1"; }
function setUnlocked(v){ sessionStorage.setItem(LS_UNLOCKED, v ? "1" : "0"); }

/** ========= Relax tips ========= */
const relaxTips = [
  "ğŸŒ¬ æ·±å‘¼å¸ã‚’3å›ã€‚é¼»ã‹ã‚‰å¸ã£ã¦ã€å£ã‹ã‚‰ã‚†ã£ãã‚Š",
  "ğŸ’§ æ°´ã‚’ä¸€å£é£²ã‚“ã§ã€è‚©ã®åŠ›ã‚’æŠœã“ã†",
  "ğŸ‘€ ç›®ã‚’é–‰ã˜ã¦10ç§’ã€‚ç”»é¢ã‹ã‚‰ç›®ã‚’é›¢ãã†",
  "ğŸ™†â€â™‚ï¸ å¤§ããèƒŒä¼¸ã³ã—ã¦ã¿ã‚ˆã†",
  "ğŸŒ€ é¦–ã‚„è‚©ã‚’ã‚†ã£ãã‚Šå›ã—ã¦ã¿ã‚ˆã†",
  "ğŸš¶ å¤–ã®ç©ºæ°—ã‚’å¸ã„ã«è¡Œã“ã†",
  "ğŸªŸ çª“ã®å¤–ã‚’10ç§’çœºã‚ã¦ã¿ã‚ˆã†"
];
function pickRelax(){ return relaxTips[Math.floor(Math.random()*relaxTips.length)]; }

/** ========= Main UI wiring ========= */
let settings = loadSettings();

const folderHint = document.getElementById("folderHint");
const copyFolderBtn = document.getElementById("copyFolderBtn");
const openFolderBtn = document.getElementById("openFolderBtn");
const setFolderUrlEl = document.getElementById("setFolderUrl");

const imageUrlEl = document.getElementById("imageUrl");
const purposeEl = document.getElementById("purpose");
const stayFields = document.getElementById("stayFields");
const approvalFields = document.getElementById("approvalFields");
const amountEl = document.getElementById("amount");
const nightsEl = document.getElementById("nights");
const approvedEl = document.getElementById("approved");
const memoEl = document.getElementById("memo");
const dateEl = document.getElementById("date");
const modeHint = document.getElementById("modeHint");

function updateFolderUI(){
  if(settings.folderUrl){
    folderHint.textContent = settings.folderUrl;
  }else{
    folderHint.textContent = "æœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ãŒâš™ï¸è¨­å®šã§ä¿å­˜å…ˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚";
  }
  copyFolderBtn.disabled = !settings.folderUrl;
  openFolderBtn.disabled = !settings.folderUrl;
}
updateFolderUI();

copyFolderBtn.onclick = async () => {
  if(!settings.folderUrl) return;
  try{ await setClipboard(settings.folderUrl); alert("ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
  catch{ alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã®å¯èƒ½æ€§ï¼‰"); }
};
openFolderBtn.onclick = () => {
  if(!settings.folderUrl) return;
  window.open(settings.folderUrl, "_blank", "noopener");
};

modeHint.textContent = "âœï¸ ç¾åœ¨ï¼šæ‰‹å…¥åŠ›ä¸­å¿ƒï¼ˆå°†æ¥ï¼šAIã§è‡ªå‹•æŠ½å‡ºã‚‚è¿½åŠ å¯èƒ½ï¼‰";

// default date = today
(function initDate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  dateEl.value = `${y}-${m}-${day}`;
})();

purposeEl.onchange = () => {
  const v = purposeEl.value;
  stayFields.classList.toggle("hidden", v !== "stay");
  const showApproval = ["meeting","entertainment","stay"].includes(v);
  approvalFields.classList.toggle("hidden", !showApproval);
};

function badge(status){
  if(status==="ok") return `<span class="badge ok">ğŸŸ¢ å•é¡Œãªã—</span>`;
  if(status==="warn") return `<span class="badge warn">ğŸŸ¡ è¦ç¢ºèª</span>`;
  return `<span class="badge danger">ğŸ”´ è¦å¯¾å¿œ</span>`;
}

function purposeLabel(v){
  const map = {
    traffic:"äº¤é€šè²»",
    stay:"å®¿æ³Šè²»",
    supplies:"æ¶ˆè€—å“",
    meeting:"ä¼šè­°è²»",
    entertainment:"äº¤éš›è²»"
  };
  return map[v] || v;
}

function evaluate(){
  const purpose = purposeEl.value;
  const amount = Number(amountEl.value || 0);
  const nights = Math.max(1, Number(nightsEl.value || 1));
  const approved = !!approvedEl.checked;

  let status = "ok";
  let reasons = [];

  if(!amount){
    status = "danger";
    reasons.push("é‡‘é¡ãŒæœªå…¥åŠ›ã§ã™");
  }

  if(purpose === "meeting" && settings.meetingApprovalRequired && !approved){
    status = "danger";
    reasons.push("ä¼šè­°è²»ï¼šäº‹å‰æ‰¿èªãŒã‚ã‚Šã¾ã›ã‚“");
  }
  if(purpose === "entertainment" && settings.entertainmentApprovalRequired && !approved){
    status = "danger";
    reasons.push("äº¤éš›è²»ï¼šäº‹å‰æ‰¿èªãŒã‚ã‚Šã¾ã›ã‚“");
  }
  if(purpose === "stay" && settings.stayApprovalRequired && !approved){
    status = "danger";
    reasons.push("å®¿æ³Šè²»ï¼šäº‹å‰æ‰¿èªãŒã‚ã‚Šã¾ã›ã‚“");
  }

  if(purpose === "stay" && amount > 0){
    const perNight = amount / nights;
    if(perNight > settings.stayLimit){
      let act = settings.stayOverAction;
      if(approved && settings.stayApprovedDowngrade) act = "warn";
      if(status !== "danger") status = act;
      reasons.push(`å®¿æ³Šè²»ï¼š${Math.round(perNight)}å††/æ³Šï¼ˆä¸Šé™${settings.stayLimit}å††è¶…ï¼‰`);
    }
  }

  const d = new Date(dateEl.value);
  if(!isNaN(d.getTime())){
    const days = Math.floor((Date.now() - d.getTime()) / (1000*60*60*24));
    if(days > 90){
      status = "danger";
      reasons.push("æ—¥ä»˜ï¼š3ã‹æœˆä»¥ä¸Šå‰ï¼ˆè¦å¯¾å¿œï¼‰");
    }else if(days > 60 && status === "ok"){
      status = "warn";
      reasons.push("æ—¥ä»˜ï¼š2ã‹æœˆä»¥ä¸Šå‰ï¼ˆè¦ç¢ºèªï¼‰");
    }
  }

  return {status, reasons};
}

function buildCsv(applicationId, status, reasons){
  const purpose = purposeEl.value;
  const amount = Number(amountEl.value || 0);
  const nights = purpose === "stay" ? Math.max(1, Number(nightsEl.value || 1)) : "";
  const approved = !!approvedEl.checked;
  const memo = memoEl.value || "";
  const imgUrl = imageUrlEl.value.trim();

  const values = {
    "ç”³è«‹ID": applicationId,
    "ç”»åƒç•ªå·": applicationId,
    "ç”»åƒURL": imgUrl,
    "æ—¥ä»˜": dateEl.value || "",
    "ç”¨é€”": purposeLabel(purpose),
    "é‡‘é¡": amount || "",
    "æ³Šæ•°": nights,
    "äº‹å‰æ‰¿èª": approved ? "TRUE" : "FALSE",
    "ãƒ¡ãƒ¢": memo,
    "åˆ¤å®š": status==="ok" ? "ğŸŸ¢" : status==="warn" ? "ğŸŸ¡" : "ğŸ”´",
    "åˆ¤å®šç†ç”±": reasons.join("; ")
  };

  const row = CSV_HEADER.map(h => values[h] ?? "");
  return toCsvRow(CSV_HEADER) + "\n" + toCsvRow(row) + "\n";
}

document.getElementById("saveBtn").onclick = () => {
  if(!settings.folderUrl){
    alert("ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ãŒæœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ãŒâš™ï¸è¨­å®šã§ä¿å­˜å…ˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const imgUrl = imageUrlEl.value.trim();
  if(!imgUrl){
    alert("ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒURLã¯å¿…é ˆã§ã™ã€‚ç¤¾å†…æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ãã ã•ã„ã€‚");
    return;
  }
  if(!purposeEl.value){
    alert("ç”¨é€”ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const appId = makeApplicationId();
  const {status, reasons} = evaluate();
  const relax = pickRelax();

  const csv = buildCsv(appId, status, reasons);
  downloadText(`keihi_${appId}.csv`, csv, "text/csv;charset=utf-8");

  const summaryText =
`ç”³è«‹ID: ${appId}
ç”»åƒURL: ${imgUrl}
æ—¥ä»˜: ${dateEl.value}
ç”¨é€”: ${purposeLabel(purposeEl.value)}
é‡‘é¡: ${amountEl.value}
æ³Šæ•°: ${purposeEl.value==="stay" ? nightsEl.value : ""}
äº‹å‰æ‰¿èª: ${approvedEl.checked ? "ã‚ã‚Š" : "ãªã—"}
åˆ¤å®š: ${status==="ok" ? "ğŸŸ¢" : status==="warn" ? "ğŸŸ¡" : "ğŸ”´"}
åˆ¤å®šç†ç”±: ${reasons.join("; ")}`;

  const r = document.getElementById("result");
  r.classList.remove("hidden");
  r.innerHTML = `
    <h1>åˆ¤å®šçµæœï¼ˆCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼‰</h1>
    ${badge(status)}
    ${reasons.length ? `<ul>${reasons.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : `<div class="small">ï¼ˆç‰¹ã«æŒ‡æ‘˜ãªã—ï¼‰</div>`}

    <div class="row" style="margin-top:10px">
      <button class="ghost" id="copySummaryBtn" style="flex:0 0 auto; width:auto; padding:10px 12px">ğŸ“‹ åˆ¤å®šã‚µãƒãƒªã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="ghost" id="openFolderBtn2" style="flex:0 0 auto; width:auto; padding:10px 12px">ğŸ“ ä¿å­˜å…ˆã‚’é–‹ã</button>
    </div>

    <div class="small mono" style="white-space:pre-wrap;margin-top:10px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px">${escapeHtml(summaryText)}</div>

    <div class="small" style="margin-top:10px">
      âœ… <b>å–¶æ¥­å‘ã‘æ³¨æ„</b>ï¼šä½œæˆã—ãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ç¤¾å†…è¦å®šã®ä¿ç®¡å ´æ‰€ã¾ãŸã¯è²¬ä»»è€…ã®æŒ‡å®šã™ã‚‹ä¿ç®¡å ´æ‰€ã¸æ ¼ç´ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="relax">
      ğŸ«¶ <strong>30ç§’ãŠã™ã™ã‚ãƒªãƒ©ãƒƒã‚¯ã‚¹</strong><br>
      ä»Šæ—¥ã®ãƒ’ãƒ³ãƒˆï¼š ${escapeHtml(relax)}
    </div>
  `;

  document.getElementById("copySummaryBtn").onclick = async () => {
    try{ await setClipboard(summaryText); alert("åˆ¤å®šã‚µãƒãƒªã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    catch{ alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã®å¯èƒ½æ€§ï¼‰"); }
  };
  document.getElementById("openFolderBtn2").onclick = () => window.open(settings.folderUrl, "_blank", "noopener");
};

/** ========= Settings UI ========= */
const settingsDlg = document.getElementById("settingsDlg");
const passDlg = document.getElementById("passDlg");
const changePassDlg = document.getElementById("changePassDlg");

function fillSettingsUI(s){
  setFolderUrlEl.value = s.folderUrl || "";
  document.getElementById("setStayLimit").value = s.stayLimit;
  document.getElementById("setStayOverAction").value = s.stayOverAction;
  document.getElementById("setStayApprovalRequired").checked = !!s.stayApprovalRequired;
  document.getElementById("setStayApprovedDowngrade").checked = !!s.stayApprovedDowngrade;
  document.getElementById("setMeetingApprovalRequired").checked = !!s.meetingApprovalRequired;
  document.getElementById("setEntertainmentApprovalRequired").checked = !!s.entertainmentApprovalRequired;
  document.getElementById("settingsMsg").textContent = "";
}
function collectSettingsUI(){
  const folderUrl = (setFolderUrlEl.value || "").trim();
  const stayLimit = Number(document.getElementById("setStayLimit").value || 0);
  if(stayLimit < 0) throw new Error("å®¿æ³Šè²»ä¸Šé™ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
  return {
    folderUrl,
    stayLimit: stayLimit || DEFAULT_SETTINGS.stayLimit,
    stayOverAction: document.getElementById("setStayOverAction").value,
    stayApprovalRequired: document.getElementById("setStayApprovalRequired").checked,
    stayApprovedDowngrade: document.getElementById("setStayApprovedDowngrade").checked,
    meetingApprovalRequired: document.getElementById("setMeetingApprovalRequired").checked,
    entertainmentApprovalRequired: document.getElementById("setEntertainmentApprovalRequired").checked
  };
}

document.getElementById("downloadTemplateBtn").onclick = () => {
  const csv = toCsvRow(CSV_HEADER) + "\n";
  downloadText("keihiseisan_template.csv", csv, "text/csv;charset=utf-8");
  document.getElementById("settingsMsg").textContent = "â¬‡ï¸ CSVã²ãªå½¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚";
};

/** ========= Passcode flow ========= */
document.getElementById("openSettings").onclick = async () => {
  if(isUnlocked()){
    fillSettingsUI(loadSettings());
    settingsDlg.showModal();
    return;
  }
  const has = await hasPasscode();
  document.getElementById("firstSetupBlock").classList.toggle("hidden", has);
  document.getElementById("loginBlock").classList.toggle("hidden", !has);
  document.getElementById("passMsg").textContent = "";
  passDlg.showModal();
};
document.getElementById("closePassDlg").onclick = () => passDlg.close();

document.getElementById("setPassBtn").onclick = async () => {
  const p1 = (document.getElementById("newPass1").value || "").trim();
  const p2 = (document.getElementById("newPass2").value || "").trim();
  const msg = document.getElementById("passMsg");
  msg.textContent = "";

  if(p1.length < 4 || p1.length > 12){ msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯4ã€œ12æ–‡å­—ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚"; return; }
  if(p1 !== p2){ msg.textContent = "ç¢ºèªç”¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"; return; }

  const h = await sha256Hex(p1);
  localStorage.setItem(LS_PASS_HASH, h);
  setUnlocked(true);

  passDlg.close();
  fillSettingsUI(loadSettings());
  settingsDlg.showModal();
};

document.getElementById("unlockBtn").onclick = async () => {
  const input = (document.getElementById("passInput").value || "").trim();
  const msg = document.getElementById("passMsg");
  msg.textContent = "";

  const saved = localStorage.getItem(LS_PASS_HASH);
  if(!saved){ msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæœªè¨­å®šã§ã™ã€‚"; return; }
  const h = await sha256Hex(input);
  if(h !== saved){ msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚"; return; }

  setUnlocked(true);
  passDlg.close();
  fillSettingsUI(loadSettings());
  settingsDlg.showModal();
};

/** ========= Settings dialog buttons ========= */
document.getElementById("closeSettings").onclick = () => settingsDlg.close();

document.getElementById("saveSettings").onclick = () => {
  try{
    const s = collectSettingsUI();
    storeSettings(s);
    settings = loadSettings();
    updateFolderUI();
    document.getElementById("settingsMsg").textContent = "âœ… ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰";
  }catch(e){
    alert(e.message);
  }
};
document.getElementById("resetSettings").onclick = () => {
  storeSettings({...DEFAULT_SETTINGS});
  settings = loadSettings();
  fillSettingsUI(settings);
  updateFolderUI();
  document.getElementById("settingsMsg").textContent = "â†© åˆæœŸå€¤ã«æˆ»ã—ã¾ã—ãŸ";
};

/** ========= Passcode change / clear ========= */
document.getElementById("changePassBtn").onclick = () => {
  document.getElementById("curPass").value = "";
  document.getElementById("chgPass1").value = "";
  document.getElementById("chgPass2").value = "";
  document.getElementById("chgMsg").textContent = "";
  changePassDlg.showModal();
};
document.getElementById("closeChangePassDlg").onclick = () => changePassDlg.close();

document.getElementById("applyPassChangeBtn").onclick = async () => {
  const cur = (document.getElementById("curPass").value || "").trim();
  const p1 = (document.getElementById("chgPass1").value || "").trim();
  const p2 = (document.getElementById("chgPass2").value || "").trim();
  const msg = document.getElementById("chgMsg");
  msg.textContent = "";

  const saved = localStorage.getItem(LS_PASS_HASH);
  if(!saved){ msg.textContent = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæœªè¨­å®šã§ã™ã€‚"; return; }

  const curH = await sha256Hex(cur);
  if(curH !== saved){ msg.textContent = "ç¾åœ¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚"; return; }

  if(p1.length < 4 || p1.length > 12){ msg.textContent = "æ–°ã—ã„ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯4ã€œ12æ–‡å­—ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚"; return; }
  if(p1 !== p2){ msg.textContent = "ç¢ºèªç”¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"; return; }

  const newH = await sha256Hex(p1);
  localStorage.setItem(LS_PASS_HASH, newH);
  msg.textContent = "âœ… ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚";
};

document.getElementById("clearPassBtn").onclick = () => {
  const ok = confirm("ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\næ¬¡å›ä»¥é™ã€è¨­å®šå¤‰æ›´ã«ã¯å†åº¦ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚");
  if(!ok) return;
  localStorage.removeItem(LS_PASS_HASH);
  setUnlocked(false);
  alert("ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚æ¬¡å›ã¯åˆå›è¨­å®šã‹ã‚‰ã«ãªã‚Šã¾ã™ã€‚");
};
</script>
</body>
</html>
